name: Deploy Frontend to VPS

on:
  push:
    branches: [main]

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build Next.js
        run: |
          echo "Running Next.js build..."
          npm run build

      - name: Verify .next folder
        run: |
          echo "Checking .next directory:"
          ls -al .next || { echo ".next folder missing! Build FAILED"; exit 1; }

      - name: Archive production build
        run: |
          echo "Creating build.tar.gz..."
          tar -czf build.tar.gz .next public package.json next.config.js

      - name: Verify artifact exists
        run: |
          echo "Verifying build.tar.gz:"
          ls -al build.tar.gz || { echo "build.tar.gz not found!"; exit 1; }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: build.tar.gz
          retention-days: 1


  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Debug secrets values
        run: |
          echo "HOST=[$DEPLOY_HOST]"
          echo "USER=[$DEPLOY_USER]"
          echo "PORT=[$DEPLOY_PORT]"
          echo "DIR=[$REMOTE_APP_DIR]"
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          REMOTE_APP_DIR: ${{ secrets.REMOTE_APP_DIR }}

      - name: Deploy to VPS
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          REMOTE_APP_DIR: ${{ secrets.REMOTE_APP_DIR }}
        run: |
          set -e

          echo "Accepting SSH host key..."
          ssh-keyscan -p $DEPLOY_PORT $DEPLOY_HOST >> ~/.ssh/known_hosts

          echo "Creating remote directory..."
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $REMOTE_APP_DIR"

          echo "Uploading build..."
          scp -P $DEPLOY_PORT build.tar.gz $DEPLOY_USER@$DEPLOY_HOST:$REMOTE_APP_DIR/

          echo "Extracting build..."
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "
            cd $REMOTE_APP_DIR &&
            tar -xzf build.tar.gz &&
            rm build.tar.gz
          "

          echo "Deployment completed successfully."
